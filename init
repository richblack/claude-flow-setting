#!/bin/bash

# Claude Flow æ¥µç°¡ä¸€éµè¨­å®š
# ä½¿ç”¨æ–¹å¼ï¼š~/claude-flow-setting/init
# è‡ªå‹•åˆ¤æ–·æ˜¯æ–°å°ˆæ¡ˆé‚„æ˜¯ç¾æœ‰å°ˆæ¡ˆ

set -e

CURRENT_DIR=$(basename "$(pwd)")
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "ğŸŒŠ Claude Flow æ¥µç°¡è¨­å®š"
echo ""

# æª¢æ¸¬é€šçŸ¥å·¥å…·
detect_notifier() {
    if command -v terminal-notifier >/dev/null 2>&1; then
        echo "terminal-notifier"
    elif command -v notify-send >/dev/null 2>&1; then
        echo "notify-send"
    else
        echo "none"
    fi
}

NOTIFIER=$(detect_notifier)

# æç¤ºå®‰è£é€šçŸ¥å·¥å…·
if [[ "$NOTIFIER" == "none" ]]; then
    echo "âš ï¸  å»ºè­°å®‰è£é€šçŸ¥å·¥å…·ä»¥ç²å¾—æœ€ä½³é«”é©—ï¼š"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "   macOS: brew install terminal-notifier"
    else
        echo "   Linux: sudo apt-get install libnotify-bin"
    fi
    echo ""
fi

# è‡ªå‹•åˆ¤æ–·å ´æ™¯
if [[ -f "CLAUDE.md" ]] || [[ -d ".claude" ]] || [[ -d "rfp" ]]; then
    echo "âš ï¸  æ­¤å°ˆæ¡ˆä¼¼ä¹å·²ç¶“è¨­å®šé Claude Flow"
    read -p "æ˜¯å¦è¦é‡æ–°è¨­å®šï¼Ÿ(y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ å–æ¶ˆè¨­å®š"
        exit 0
    fi
fi

echo "ğŸ”§ åœ¨å°ˆæ¡ˆ '$CURRENT_DIR' ä¸­è¨­å®š..."

# åˆå§‹åŒ– gitï¼ˆå¦‚æœéœ€è¦ï¼‰
if [[ ! -d ".git" ]]; then
    git init -q
    echo "âœ“ åˆå§‹åŒ– Git"
fi

# 1. å‰µå»º rfp/ ç›®éŒ„å’Œéœ€æ±‚ç¯„æœ¬
echo "ğŸ“ å‰µå»º rfp/ éœ€æ±‚ç›®éŒ„..."
mkdir -p rfp

PROJ_NAME="$CURRENT_DIR"

cat > rfp/requirements.md << EOF
# $PROJ_NAME å°ˆæ¡ˆéœ€æ±‚

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™

[ç°¡è¦æè¿°é€™å€‹å°ˆæ¡ˆè¦è§£æ±ºä»€éº¼å•é¡Œ]

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚

### æ ¸å¿ƒåŠŸèƒ½
- [ ] åŠŸèƒ½ 1
- [ ] åŠŸèƒ½ 2
- [ ] åŠŸèƒ½ 3

### æ¬¡è¦åŠŸèƒ½
- [ ] åŠŸèƒ½ 4
- [ ] åŠŸèƒ½ 5

## ğŸ›  æŠ€è¡“éœ€æ±‚

- **èªè¨€/æ¡†æ¶**:
- **è³‡æ–™åº«**:
- **éƒ¨ç½²ç’°å¢ƒ**:

## ğŸ“ è£œå……èªªæ˜

[ä»»ä½•é¡å¤–çš„æŠ€è¡“ç´°ç¯€æˆ–é™åˆ¶]

---

**æç¤º**: ç·¨è¼¯å®Œæˆå¾Œï¼Œå‘Šè¨´ Claude:ã€Œè«‹é–±è®€ rfp/ é–‹å§‹é–‹ç™¼ã€
EOF

echo "âœ“ å·²å‰µå»º rfp/requirements.md"

# 2. å‰µå»º .claude ç›®éŒ„å’Œ settings.jsonï¼ˆé…ç½®é€šçŸ¥ hooksï¼‰
echo "âš™ï¸  é…ç½® Claude Code é€šçŸ¥..."
mkdir -p .claude

# æ ¹æ“šåµæ¸¬åˆ°çš„é€šçŸ¥å·¥å…·å‰µå»ºé…ç½®
if [[ "$NOTIFIER" == "terminal-notifier" ]]; then
    NOTIFY_CMD='terminal-notifier -message \"Claude Code éœ€è¦æ‚¨çš„æ³¨æ„\" -title \"Claude Code\" -sound default'
    STOP_CMD='terminal-notifier -message \"ä»»å‹™å·²å®Œæˆ\" -title \"Claude Code\" -sound default'
elif [[ "$NOTIFIER" == "notify-send" ]]; then
    NOTIFY_CMD='notify-send "Claude Code" "éœ€è¦æ‚¨çš„æ³¨æ„"'
    STOP_CMD='notify-send "Claude Code" "ä»»å‹™å·²å®Œæˆ"'
else
    # å›é€€åˆ°ç°¡å–®çš„ echo
    NOTIFY_CMD='echo "ğŸ”” Claude Code éœ€è¦æ‚¨çš„æ³¨æ„"'
    STOP_CMD='echo "âœ… ä»»å‹™å·²å®Œæˆ"'
fi

cat > .claude/settings.json << EOF
{
  "hooks": {
    "Notification": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "$NOTIFY_CMD"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "$STOP_CMD"
          }
        ]
      }
    ]
  },
  "permissions": {
    "allow": [
      "Bash(terminal-notifier:*)",
      "Bash(notify-send:*)"
    ]
  }
}
EOF

echo "âœ“ å·²é…ç½®é€šçŸ¥ hooks"

# 3. å‰µå»º CLAUDE.mdï¼ˆå°ˆæ¡ˆç´šåˆ¥çš„ Claude æŒ‡ä»¤ï¼‰
echo "ğŸ“ å‰µå»º CLAUDE.md..."

cat > CLAUDE.md << 'EOF'
# Claude Flow é–‹ç™¼æŒ‡å—

## ğŸ¯ é–‹ç™¼æµç¨‹

### 1. é–‹å§‹å‰å¿…è®€
- **æ°¸é å…ˆé–±è®€ `rfp/` ç›®éŒ„**ï¼šç†è§£éœ€æ±‚å¾Œå†é–‹å§‹é–‹ç™¼
- **ä½¿ç”¨è¨˜æ†¶ç³»çµ±**ï¼šé‡è¦æ±ºç­–å’Œé€²åº¦éƒ½è¦è¨˜éŒ„

### 2. æ¨™æº–é–‹ç™¼æµç¨‹

```bash
# å•Ÿå‹•æ™‚ - æ¢å¾©è¨˜æ†¶
claude-flow memory recall "*"

# é–±è®€éœ€æ±‚
# è«‹ä»”ç´°é–±è®€ rfp/ ç›®éŒ„ä¸­çš„æ‰€æœ‰éœ€æ±‚æ–‡ä»¶

# è¦åŠƒæ¶æ§‹
claude-flow sparc run architect "æ ¹æ“š rfp/ éœ€æ±‚è¨­è¨ˆæ¶æ§‹"

# é–‹å§‹é–‹ç™¼
claude-flow sparc run coder "å¯¦ä½œåŠŸèƒ½"

# æ¸¬è©¦
claude-flow sparc run tdd "å»ºç«‹æ¸¬è©¦"

# çµæŸæ™‚ - ä¿å­˜è¨˜æ†¶
claude-flow memory store "progress" "ä»Šæ—¥å®Œæˆï¼šXXX"
```

## ğŸ”” é€šçŸ¥è¦å‰‡

### ä½•æ™‚å¿…é ˆä¸»å‹•è©¢å•ç”¨æˆ¶

1. **éœ€è¦æ±ºç­–æ™‚**
   - å¤šç¨®å¯¦ä½œæ–¹æ¡ˆå¯é¸æ“‡
   - æ¶æ§‹è¨­è¨ˆçš„é‡è¦æ±ºå®š
   - æŠ€è¡“æ£§é¸æ“‡

2. **é‡åˆ°é˜»ç¤™æ™‚**
   - éŒ¯èª¤ç„¡æ³•è‡ªè¡Œè§£æ±º
   - éœ€æ±‚ä¸æ¸…æ¥š
   - æ¸¬è©¦å¤±æ•—ä¸”åŸå› ä¸æ˜

3. **å®Œæˆéšæ®µæ€§ä»»å‹™æ™‚**
   - å®Œæˆä¸€å€‹ä¸»è¦åŠŸèƒ½
   - å®Œæˆæ¸¬è©¦
   - æº–å‚™éƒ¨ç½²

### é€šçŸ¥æ–¹å¼

ç•¶éœ€è¦ç”¨æˆ¶æ³¨æ„æ™‚ï¼š
- ç³»çµ±æœƒè‡ªå‹•å½ˆå‡ºé€šçŸ¥ï¼ˆé€é hooksï¼‰
- åœ¨è¨Šæ¯ä¸­æ˜ç¢ºèªªæ˜éœ€è¦ä»€éº¼
- ç­‰å¾…ç”¨æˆ¶å›æ‡‰å¾Œå†ç¹¼çºŒ

## ğŸ“‹ æœ€ä½³å¯¦è¸

### Do âœ…
- å…ˆè®€ rfp/ å†å‹•æ‰‹
- é‡è¦æ±ºç­–è¨˜éŒ„åˆ° memory
- éœ€è¦ç¢ºèªæ™‚ä¸»å‹•è©¢å•
- éšæ®µå®Œæˆå¾Œé€šçŸ¥ç”¨æˆ¶

### Don't âŒ
- ä¸è¦å‡è¨­éœ€æ±‚ï¼Œæœ‰ç–‘å•å°±å•
- ä¸è¦è·³éæ¸¬è©¦
- ä¸è¦åœ¨ä¸ç¢ºå®šæ™‚ç¹¼çºŒé–‹ç™¼
- ä¸è¦å¿˜è¨˜ä¿å­˜è¨˜æ†¶

## ğŸ’¾ è¨˜æ†¶ç³»çµ±ä½¿ç”¨

```bash
# ä¿å­˜æ¶æ§‹æ±ºç­–
claude-flow memory store "architecture" "ä½¿ç”¨ å¾®æœå‹™æ¶æ§‹ï¼ŒAPI Gateway + 3å€‹æœå‹™"

# ä¿å­˜æŠ€è¡“æ£§
claude-flow memory store "tech-stack" "Node.js + PostgreSQL + Redis"

# ä¿å­˜é€²åº¦
claude-flow memory store "progress" "å®Œæˆç”¨æˆ¶èªè­‰æ¨¡çµ„"

# ä¿å­˜å•é¡Œ
claude-flow memory store "issues" "è³‡æ–™åº«é€£ç·šæ± éœ€è¦å„ªåŒ–"

# æŸ¥è©¢ç‰¹å®šè¨˜æ†¶
claude-flow memory query "architecture"

# æ¢å¾©æ‰€æœ‰è¨˜æ†¶
claude-flow memory recall "*"
```

## ğŸš¨ ç‰¹åˆ¥æ³¨æ„

1. **ä¸Šä¸‹æ–‡å£“ç¸®å¾Œçš„æ¢å¾©**
   - å¦‚æœå¿˜è¨˜ä¹‹å‰çš„å·¥ä½œï¼Œç«‹å³åŸ·è¡Œï¼š`claude-flow memory recall "*"`
   - é‡æ–°é–±è®€ `rfp/requirements.md`

2. **é•·æ™‚é–“åŸ·è¡Œçš„ä»»å‹™**
   - å®šæœŸå ±å‘Šé€²åº¦
   - éšæ®µå®Œæˆæ™‚é€šçŸ¥ç”¨æˆ¶

3. **éœ€è¦ç”¨æˆ¶ä»‹å…¥**
   - ç³»çµ±æœƒè‡ªå‹•è§¸ç™¼é€šçŸ¥
   - æ˜ç¢ºèªªæ˜éœ€è¦ä»€éº¼æ±ºç­–æˆ–è¡Œå‹•

---

**è¨˜ä½**ï¼šé€šçŸ¥åŠŸèƒ½å·²é€é `.claude/settings.json` çš„ hooks é…ç½®ï¼Œ
ä¸å—ä¸Šä¸‹æ–‡å£“ç¸®å½±éŸ¿ï¼Œæœƒç©©å®šé‹ä½œï¼
EOF

echo "âœ“ å·²å‰µå»º CLAUDE.md"

# 4. å‰µå»º .gitignoreï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [[ ! -f ".gitignore" ]]; then
    cat > .gitignore << EOF
# Claude Flow
.roomodes
.claude/settings.local.json

# ç’°å¢ƒè®Šæ•¸
.env
.env.local

# ä¾è³´
node_modules/
venv/
__pycache__/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
EOF
    echo "âœ“ å·²å‰µå»º .gitignore"
fi

# 5. å‰µå»ºç°¡å–®çš„ READMEï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [[ ! -f "README.md" ]]; then
    cat > README.md << EOF
# $PROJ_NAME

> Claude Flow é–‹ç™¼å°ˆæ¡ˆ

## ğŸš€ å¿«é€Ÿé–‹å§‹

1. **ç·¨è¼¯éœ€æ±‚**: \`rfp/requirements.md\`
2. **é–‹å§‹é–‹ç™¼**: å‘Šè¨´ Claudeã€Œè«‹é–±è®€ rfp/ é–‹å§‹é–‹ç™¼ã€
3. **æŸ¥çœ‹é€²åº¦**: \`claude-flow memory recall "*"\`

## ğŸ“ å°ˆæ¡ˆçµæ§‹

\`\`\`
$PROJECT_NAME/
â”œâ”€â”€ rfp/                    # éœ€æ±‚æ–‡ä»¶
â”‚   â””â”€â”€ requirements.md
â”œâ”€â”€ CLAUDE.md              # Claude é–‹ç™¼æŒ‡å—
â”œâ”€â”€ .claude/               # Claude Code è¨­å®š
â”‚   â””â”€â”€ settings.json      # é€šçŸ¥ hooks é…ç½®
â””â”€â”€ README.md
\`\`\`

## ğŸ’¡ é–‹ç™¼æµç¨‹

\`\`\`bash
# 1. æ¢å¾©è¨˜æ†¶
claude-flow memory recall "*"

# 2. Claude æœƒè‡ªå‹•è®€å– rfp/ ä¸¦é–‹å§‹é–‹ç™¼

# 3. ä¿å­˜é€²åº¦
claude-flow memory store "progress" "å®Œæˆ XXX åŠŸèƒ½"
\`\`\`

## ğŸ”” é€šçŸ¥ç³»çµ±

- âœ… ç³»çµ±æœƒåœ¨éœ€è¦æ‚¨æ³¨æ„æ™‚è‡ªå‹•å½ˆå‡ºé€šçŸ¥
- âœ… ä¸å—ä¸Šä¸‹æ–‡å£“ç¸®å½±éŸ¿
- âœ… ç©©å®šå¯é 

---

ä½¿ç”¨ [Claude Flow](https://github.com/ruvnet/claude-flow) é–‹ç™¼
EOF
    echo "âœ“ å·²å‰µå»º README.md"
fi

echo ""
echo "âœ… è¨­å®šå®Œæˆï¼"
echo ""
echo "ğŸ“ å°ˆæ¡ˆä½ç½®: $(pwd)"
echo ""

if [[ "$NOTIFIER" == "none" ]]; then
    echo "ğŸ’¡ æç¤ºï¼šé€šçŸ¥åŠŸèƒ½å·²é…ç½®ä½†éœ€è¦å®‰è£é€šçŸ¥å·¥å…·ï¼š"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "   åŸ·è¡Œ: brew install terminal-notifier"
    else
        echo "   åŸ·è¡Œ: sudo apt-get install libnotify-bin"
    fi
    echo ""
fi

echo "ğŸ¯ ä¸‹ä¸€æ­¥ï¼š"
echo "1. ç·¨è¼¯ rfp/requirements.md æè¿°æ‚¨çš„éœ€æ±‚"
echo "2. åœ¨ Claude Code ä¸­é–‹å•Ÿæ­¤ç›®éŒ„"
echo "3. å‘Šè¨´ Claudeï¼šã€Œè«‹é–±è®€ rfp/ é–‹å§‹é–‹ç™¼ã€"
echo ""
echo "ğŸ“– æ›´å¤šè³‡è¨Šï¼š"
echo "   - æŸ¥çœ‹ CLAUDE.md äº†è§£é–‹ç™¼æµç¨‹"
echo "   - æŸ¥çœ‹ .claude/settings.json äº†è§£é€šçŸ¥é…ç½®"
echo ""

